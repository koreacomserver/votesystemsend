<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í•™êµ ì„ ê±° ê°œí‘œ ê´€ë¦¬ì</title>
  <style>
    * { box-sizing: border-box; font-family: 'Pretendard','Segoe UI',sans-serif; }
    body { margin:0; background:#0e1117; color:#f0f0f0; overflow-x:hidden; }
    header { background:#1a2238; padding:1.2rem 2rem; font-size:1.6rem; font-weight:bold; border-bottom:2px solid #304b99; text-align:center; }
    main { max-width:900px; margin:2rem auto; padding:2rem; background:#161b26; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,0.3); }
    h2 { border-left:5px solid #3a6ff8; padding-left:10px; margin-top:2rem; display:flex; justify-content:space-between; align-items:center;}
    .candidate-list { display:grid; gap:1rem; margin-top:1rem; }
    .candidate-item { display:flex; justify-content:space-between; align-items:center; background:#20283a; padding:1rem; border-radius:8px; position:relative;}
    .info { display:flex; align-items:center; gap:1rem;}
    input[type="text"],input[type="number"]{ background:#121826; color:white; border:1px solid #3a6ff8; border-radius:6px; padding:6px 10px; width:120px;}
    button{ background:#3a6ff8; border:none; color:white; padding:8px 16px; border-radius:8px; cursor:pointer; transition:0.2s;}
    button:hover{ background:#5888ff;}
    .delete-btn{ background:#c0392b;}
    .status{ margin-top:1.5rem; text-align:center; color:#88ffb6;}
    .add-form{ display:flex; gap:0.5rem; margin-top:1rem;}
    .percent{ color:#7fd4ff; font-size:0.9rem; margin-left:6px;}
    .badge{ background:#ffb347; color:#000; font-weight:bold; padding:3px 8px; border-radius:6px; position:absolute; top:-10px; right:-10px; font-size:0.8rem; box-shadow:0 0 5px rgba(0,0,0,0.4);}
    /* â‘  ì „ì—­ turnout-box ì‚­ì œë¨. ì´ ìŠ¤íƒ€ì¼ì€ ì§ì±…ë³„ ë°•ìŠ¤ì— ì ìš©ë¨ */
    .turnout-box{ margin-top:2rem; padding:1rem; background:#20283a; border-radius:8px; display:flex; gap:10px; align-items:center;} 
    /* ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´ */
    #winnerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }
    #winnerOverlay h1 { font-size: 5rem; margin-bottom: 1rem; color:#00d8ff;}
    #winnerOverlay h2 { font-size: 2rem; margin-bottom: 0.5rem;}
    #winnerOverlay p { font-size: 1.5rem; color:#ccc;}
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
  </style>
</head>
<body>
  <header>ğŸ« í•™êµ ì„ ê±° ê°œí‘œ ê´€ë¦¬ì</header>
  <main>
    <section id="positions"></section>

    <!-- â‘  ê¸°ì¡´ "ì „ì²´ íˆ¬í‘œìœ¨ ì„¤ì •" ë°•ìŠ¤ ì‚­ì œë¨ -->

    <div class="status" id="status">Firestore ì—°ê²° ì¤‘...</div>
  </main>

  <!-- ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´ -->
  <div id="winnerOverlay" onclick="closeOverlay()">
    <h2>ë‹¹ì„ </h2>
    <h1 id="winnerName">í™ê¸¸ë™</h1>
    <p id="winnerDetail">ë“í‘œìœ¨ 52.3%</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs,
      addDoc, deleteDoc, setDoc, onSnapshot, getDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLge3LmR3bCTb7gKnVMVh2s_xt7zpdQYg",
      authDomain: "votesystemserver.firebaseapp.com",
      projectId: "votesystemserver"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const positions = [
      { key: "president", label: "íšŒì¥" },
      { key: "vp_3rd", label: "3í•™ë…„ ë¶€íšŒì¥" },
      { key: "vp_2nd", label: "2í•™ë…„ ë¶€íšŒì¥" }
    ];

    const container = document.getElementById("positions");

    positions.forEach(pos => {
      const section = document.createElement("section");
      // â‘¡ ê° ì§ì±… ì„¹ì…˜ ì•„ë˜ì— "ìœ ê¶Œì ìˆ˜ ì„¤ì • ë°•ìŠ¤" ì¶”ê°€
      section.innerHTML = `
        <h2>
          ${pos.label}
          <button onclick="showWinner('${pos.key}')">ğŸ† ë‹¹ì„  ë°œí‘œ</button>
        </h2>
        <div id="${pos.key}" class="candidate-list"></div>
        <div class="add-form">
          <input type="text" id="name-${pos.key}" placeholder="í›„ë³´ ì´ë¦„" />
          <input type="number" id="votes-${pos.key}" placeholder="ë“í‘œìˆ˜" />
          <button onclick="addCandidate('${pos.key}')">ì¶”ê°€</button>
        </div>
        <div class="turnout-box">
          <label>ìœ ê¶Œì ìˆ˜: </label>
          <input type="number" id="voters-${pos.key}" placeholder="ì˜ˆ: 300" />
          <button onclick="updateVoters('${pos.key}')">ì €ì¥</button>
          <div id="turnout-${pos.key}"></div>
        </div>
      `;
      container.appendChild(section);
      onSnapshot(collection(db, `elections/2025/${pos.key}`), renderCandidates);
    });

    async function renderCandidates() {
      for (const pos of positions) {
        const colRef = collection(db, `elections/2025/${pos.key}`);
        const snap = await getDocs(colRef);
        const container = document.getElementById(pos.key);
        container.innerHTML = '';

        let totalVotes = 0;
        const candidates = [];
        snap.forEach(docSnap => {
          // ğŸ”¥ ìˆ˜ì •ëœ ë¶€ë¶„: ë¬¸ì„œ IDê°€ 'meta'ì¸ ê²½ìš°(ìœ ê¶Œì ìˆ˜ ì •ë³´) í›„ë³´ì ëª©ë¡ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤.
          if (docSnap.id === 'meta') { 
            return; 
          }
          const data = { id: docSnap.id, ...docSnap.data() };
          candidates.push(data);
          totalVotes += Number(data.votes || 0);
        });

        // ë“í‘œìˆœ ì •ë ¬
        candidates.sort((a,b)=>b.votes - a.votes);

        candidates.forEach((c, i) => {
          // c.votesê°€ undefinedì¼ ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬ (meta ë¬¸ì„œë¥¼ ê±¸ëŸ¬ëƒˆìœ¼ë¯€ë¡œ ë¶ˆí•„ìš”í•˜ì§€ë§Œ ì•ˆì „ì¥ì¹˜)
          const votes = Number(c.votes || 0);
          const percent = totalVotes ? ((votes / totalVotes) * 100).toFixed(1) : 0;
          const div = document.createElement('div');
          div.className = 'candidate-item';
          div.innerHTML = `
            ${i === 0 ? '<div class="badge">ë‹¹ì„  ìœ ë ¥</div>' : ''}
            <div class="info">
              <span>${c.name}</span>
              <input type="number" id="votes-${pos.key}-${c.id}" value="${c.votes}" />
              <span class="percent">${percent}%</span>
            </div>
            <div style="display:flex;gap:5px;">
              <button onclick="updateVote('${pos.key}', '${c.id}')">ì €ì¥</button>
              <button class="delete-btn" onclick="deleteCandidate('${pos.key}', '${c.id}')">ì‚­ì œ</button>
            </div>
          `;
          container.appendChild(div);
        });
      }
      document.getElementById("status").textContent = "âœ… Firestore ì—°ê²°ë¨ (ì‹¤ì‹œê°„ ë°˜ì˜ ì¤‘)";
    }

    // í›„ë³´ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ (ê¸°ì¡´ê³¼ ë™ì¼)
    window.addCandidate = async function(position) {
      const name = document.getElementById(`name-${position}`).value.trim();
      const votes = Number(document.getElementById(`votes-${position}`).value) || 0;
      if (!name) return console.error("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!"); // alert ëŒ€ì‹  console.error ì‚¬ìš©
      await addDoc(collection(db, `elections/2025/${position}`), { name, votes });
      document.getElementById(`name-${position}`).value = '';
      document.getElementById(`votes-${position}`).value = '';
    };

    window.updateVote = async function(position, id) {
      const input = document.getElementById(`votes-${position}-${id}`);
      const newVotes = Number(input.value);
      await setDoc(doc(db, `elections/2025/${position}/${id}`), { votes: newVotes }, { merge: true });
      document.getElementById('status').textContent = `ğŸ’¾ ${position} í›„ë³´ ${id}ë²ˆ ë“í‘œìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ!`;
    };

    window.deleteCandidate = async function(position, id) {
      // ğŸ”¥ ìˆ˜ì •ëœ ë¶€ë¶„: window.confirm()ì„ ì œê±°í•˜ê³  ë°”ë¡œ ì‚­ì œí•©ë‹ˆë‹¤.
      console.log(`ğŸ—‘ï¸ Deleting: elections/2025/${position}/${id}`);
      await deleteDoc(doc(db, `elections/2025/${position}/${id}`));
      document.getElementById('status').textContent = `ğŸ—‘ï¸ ${position} í›„ë³´ ì‚­ì œ ì™„ë£Œ!`;
    };

    // ì§ì±…ë³„ ìœ ê¶Œì ìˆ˜ ì €ì¥
    window.updateVoters = async function(position) {
      const total = Number(document.getElementById(`voters-${position}`).value);
      if (!total) return console.error('ìœ ê¶Œì ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
      // ì €ì¥ ê²½ë¡œ: elections/2025/{position}/meta
      await setDoc(doc(db, `elections/2025/${position}/meta`), { totalVoters: total }, { merge: true });
      document.getElementById(`turnout-${position}`).textContent = `âœ… ${total}ëª… ì €ì¥ë¨.`;
    };

    // ì§ì±…ë³„ ìœ ê¶Œì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadVoters() {
      for (const pos of positions) {
        // ë¶ˆëŸ¬ì˜¤ê¸° ê²½ë¡œ: elections/2025/{position}/meta
        const metaDoc = await getDoc(doc(db, `elections/2025/${pos.key}/meta`));
        if (metaDoc.exists()) {
          document.getElementById(`voters-${pos.key}`).value = metaDoc.data().totalVoters || '';
          document.getElementById(`turnout-${pos.key}`).textContent = `í˜„ì¬: ${metaDoc.data().totalVoters || 0}ëª…`;
        }
      }
    }

    loadVoters();
    renderCandidates(); 

    // ğŸ† ë‹¹ì„  ë°œí‘œ ì „ì²´í™”ë©´ í‘œì‹œ (ê¸°ì¡´ê³¼ ë™ì¼)
    window.showWinner = async function(position) {
      const snap = await getDocs(collection(db, `elections/2025/${position}`));
      const candidates = [];
      let totalVotes = 0;
      snap.forEach(d => {
        // 'meta' ë¬¸ì„œ í•„í„°ë§ (ë‹¤ì‹œ í•œ ë²ˆ)
        if (d.id === 'meta') return;
        candidates.push(d.data()); totalVotes += d.data().votes;
      });
      if (!candidates.length) return console.error("í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤!");

      candidates.sort((a,b)=>b.votes - a.votes);
      const winner = candidates[0];
      const percent = totalVotes ? ((winner.votes / totalVotes)*100).toFixed(1) : 0;

      document.getElementById("winnerName").textContent = winner.name;
      document.getElementById("winnerDetail").textContent = `ë“í‘œìœ¨ ${percent}%`;
      document.getElementById("winnerOverlay").style.display = "flex";
    }

    window.closeOverlay = function(){
      document.getElementById("winnerOverlay").style.display = "none";
    };

    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape") closeOverlay();
    });
  </script>
</body>
</html>
