<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>학교 선거 개표 관리자</title>
  <style>
    * { box-sizing: border-box; font-family: 'Pretendard','Segoe UI',sans-serif; }
    body { margin:0; background:#0e1117; color:#f0f0f0; overflow-x:hidden; }
    header { background:#1a2238; padding:1.2rem 2rem; font-size:1.6rem; font-weight:bold; border-bottom:2px solid #304b99; text-align:center; }
    main { max-width:900px; margin:2rem auto; padding:2rem; background:#161b26; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,0.3); }
    h2 { border-left:5px solid #3a6ff8; padding-left:10px; margin-top:2rem; display:flex; justify-content:space-between; align-items:center;}
    .candidate-list { display:grid; gap:1rem; margin-top:1rem; }
    .candidate-item { display:flex; justify-content:space-between; align-items:center; background:#20283a; padding:1rem; border-radius:8px; position:relative;}
    .info { display:flex; align-items:center; gap:1rem;}
    input[type="text"],input[type="number"]{ background:#121826; color:white; border:1px solid #3a6ff8; border-radius:6px; padding:6px 10px; width:120px;}
    button{ background:#3a6ff8; border:none; color:white; padding:8px 16px; border-radius:8px; cursor:pointer; transition:0.2s;}
    button:hover{ background:#5888ff;}
    .delete-btn{ background:#c0392b;}
    .status{ margin-top:1.5rem; text-align:center; color:#88ffb6;}
    .add-form{ display:flex; gap:0.5rem; margin-top:1rem;}
    .percent{ color:#7fd4ff; font-size:0.9rem; margin-left:6px;}
    .badge{ background:#ffb347; color:#000; font-weight:bold; padding:3px 8px; border-radius:6px; position:absolute; top:-10px; right:-10px; font-size:0.8rem; box-shadow:0 0 5px rgba(0,0,0,0.4);}
    .turnout-box{ margin-top:2rem; padding:1rem; background:#20283a; border-radius:8px;}
    /* 전체화면 오버레이 */
    #winnerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }
    #winnerOverlay h1 { font-size: 5rem; margin-bottom: 1rem; color:#00d8ff;}
    #winnerOverlay h2 { font-size: 2rem; margin-bottom: 0.5rem;}
    #winnerOverlay p { font-size: 1.5rem; color:#ccc;}
    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
  </style>
</head>
<body>
  <header>🏫 학교 선거 개표 관리자</header>
  <main>
    <section id="positions"></section>

    <div class="turnout-box">
      <h2>전체 투표율 설정</h2>
      <label>전체 유권자 수: </label>
      <input type="number" id="totalVoters" placeholder="예: 450" />
      <button onclick="updateTotalVoters()">저장</button>
      <div id="turnoutStatus"></div>
    </div>

    <div class="status" id="status">Firestore 연결 중...</div>
  </main>

  <!-- 전체화면 오버레이 -->
  <div id="winnerOverlay" onclick="closeOverlay()">
    <h2>당선</h2>
    <h1 id="winnerName">홍길동</h1>
    <p id="winnerDetail">득표율 52.3%</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs,
      addDoc, deleteDoc, setDoc, onSnapshot, getDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLge3LmR3bCTb7gKnVMVh2s_xt7zpdQYg",
      authDomain: "votesystemserver.firebaseapp.com",
      projectId: "votesystemserver"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const positions = [
      { key: "president", label: "회장" },
      { key: "vp_3rd", label: "3학년 부회장" },
      { key: "vp_2nd", label: "2학년 부회장" }
    ];

    const container = document.getElementById("positions");

    positions.forEach(pos => {
      const section = document.createElement("section");
      section.innerHTML = `
        <h2>
          ${pos.label}
          <button onclick="showWinner('${pos.key}')">🏆 당선 발표</button>
        </h2>
        <div id="${pos.key}" class="candidate-list"></div>
        <div class="add-form">
          <input type="text" id="name-${pos.key}" placeholder="후보 이름" />
          <input type="number" id="votes-${pos.key}" placeholder="득표수" />
          <button onclick="addCandidate('${pos.key}')">추가</button>
        </div>
      `;
      container.appendChild(section);
      onSnapshot(collection(db, `elections/2025/${pos.key}`), renderCandidates);
    });

    async function renderCandidates() {
      for (const pos of positions) {
        const colRef = collection(db, `elections/2025/${pos.key}`);
        const snap = await getDocs(colRef);
        const container = document.getElementById(pos.key);
        container.innerHTML = '';

        let totalVotes = 0;
        const candidates = [];
        snap.forEach(docSnap => {
          const data = { id: docSnap.id, ...docSnap.data() };
          candidates.push(data);
          totalVotes += Number(data.votes || 0);
        });

        // 득표순 정렬
        candidates.sort((a,b)=>b.votes - a.votes);

        candidates.forEach((c, i) => {
          const percent = totalVotes ? ((c.votes / totalVotes) * 100).toFixed(1) : 0;
          const div = document.createElement('div');
          div.className = 'candidate-item';
          div.innerHTML = `
            ${i === 0 ? '<div class="badge">당선 유력</div>' : ''}
            <div class="info">
              <span>${c.name}</span>
              <input type="number" id="votes-${pos.key}-${c.id}" value="${c.votes}" />
              <span class="percent">${percent}%</span>
            </div>
            <div style="display:flex;gap:5px;">
              <button onclick="updateVote('${pos.key}', '${c.id}')">저장</button>
              <button class="delete-btn" onclick="deleteCandidate('${pos.key}', '${c.id}')">삭제</button>
            </div>
          `;
          container.appendChild(div);
        });
      }
      document.getElementById("status").textContent = "✅ Firestore 연결됨 (실시간 반영 중)";
    }

    // 후보 추가/수정/삭제는 기존과 동일
    window.addCandidate = async function(position) {
      const name = document.getElementById(`name-${position}`).value.trim();
      const votes = Number(document.getElementById(`votes-${position}`).value) || 0;
      if (!name) return alert("이름을 입력하세요!");
      await addDoc(collection(db, `elections/2025/${position}`), { name, votes });
      document.getElementById(`name-${position}`).value = '';
      document.getElementById(`votes-${position}`).value = '';
    };

    window.updateVote = async function(position, id) {
      const input = document.getElementById(`votes-${position}-${id}`);
      const newVotes = Number(input.value);
      await setDoc(doc(db, `elections/2025/${position}/${id}`), { votes: newVotes }, { merge: true });
      document.getElementById('status').textContent = `💾 ${position} 후보 ${id}번 득표수 업데이트 완료!`;
    };

    window.deleteCandidate = async function(position, id) {
      if (!confirm("정말 이 후보를 삭제할까요?")) return;
      await deleteDoc(doc(db, `elections/2025/${position}/${id}`));
      document.getElementById('status').textContent = `🗑️ ${position} 후보 삭제 완료!`;
    };

    window.updateTotalVoters = async function() {
      const total = Number(document.getElementById('totalVoters').value);
      if (!total) return alert('전체 유권자 수를 입력하세요!');
      await setDoc(doc(db, 'elections/2025/meta'), { totalVoters: total }, { merge: true });
      document.getElementById('turnoutStatus').textContent = `✅ 전체 유권자 수 ${total}명 저장됨.`;
    };

    async function loadTurnout() {
      const metaDoc = await getDoc(doc(db, 'elections/2025/meta'));
      if (metaDoc.exists()) {
        document.getElementById('totalVoters').value = metaDoc.data().totalVoters || '';
      }
    }
    loadTurnout();
    renderCandidates();

    // 🏆 당선 발표 전체화면 표시
    window.showWinner = async function(position) {
      const snap = await getDocs(collection(db, `elections/2025/${position}`));
      const candidates = [];
      let totalVotes = 0;
      snap.forEach(d => { candidates.push(d.data()); totalVotes += d.data().votes; });
      if (!candidates.length) return alert("후보가 없습니다!");

      candidates.sort((a,b)=>b.votes - a.votes);
      const winner = candidates[0];
      const percent = totalVotes ? ((winner.votes / totalVotes)*100).toFixed(1) : 0;

      document.getElementById("winnerName").textContent = winner.name;
      document.getElementById("winnerDetail").textContent = `득표율 ${percent}%`;
      document.getElementById("winnerOverlay").style.display = "flex";
    }

    window.closeOverlay = function(){
      document.getElementById("winnerOverlay").style.display = "none";
    };

    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape") closeOverlay();
    });
  </script>
</body>
</html>
